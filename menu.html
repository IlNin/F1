<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Formula Driver - Menu</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
        <link rel="stylesheet" type="text/css" href="style.css"/>
    </head>
    
    <body>
        <script src="js/three.js"></script>
        <script src="js/OBJLoader.js"></script>
        
        <script>
            // Global variables
            var scene;
            var camera;
            var renderer;
            var ambientLight;
            var pointLight;
            var pointLight2;
            var loader;
            var models;
            
            var title; // Container with the title screens and the "Play", "Options" and "About" buttons
            var playButton;
            var optionsButton;
            var aboutButton;
            var options; // Container with the options
            var easyButton;
            var normalButton;
            var hardButton;
            var resolutionNativeButton;
            var resolutionLowButton;
            var shadowsOnButton;
            var shadowsOffButton;
            var ferrariButton;
            var mercedesButton;
            var redbullButton;
            var optionsExitButton; // Button that closes the Option container
            var about; // Container with the synopsis and commands
            var aboutExitButton; // Button that closes the About container
            var description;
            var hud;
            
            var menuAnimation; // Timer for the menu animation
            var gameplayAnimation; // Timer for the gameplay animation
            var leftOrRight = 0; // The player turns their car to 0: neutral, 1: left, 2: right
            var cockpit = true; // Type of camera view - true: cockpit view, false: third-person camera
            var pause = false; // Indicates if the game is paused
            
            var maxSteering = 0.5; // How far the steering wheel can turn
            var steering = 0.1; // How much the steering wheel turns at each frame
            var carTurning = 0.02; // How much the car rotates when turning the wheel at each frame
            var headTurning = 0.05; // How much the pilot's head rotates when turning the wheel at each frame
            var tyreTurning = 0.03; // How much the car's tyres rotate when turning the wheel at each frame
            var tyreSpeed = 0.05; // How fast the tyres move
            var speed = 0.005; // The velocity of the car (aka how much the objects on the road move)
            var spawnPoint = 0.5; // Coordinate X where the new objects on the road should spawn
            
            var collisionBoxPlayer;
            var collisionBoxPlayerVisible;
            var collisionOpponent;
            var collisionOpponentVisible;
            
            var difficulty = 1.0; // 0.5: Easy, 1: Normal, 1.5: Hard
            var maxOpponents = 8; // Max number of concurrent opponents on the track
            var opponents = 1; // The game starts with an opponent car already present on track
            var carSpawner; // Timer for the initial spawn of the opponent cars
            var timer = 0; // Timer used in carSpawner
            var passes = 0; // How many opponent cars the player has passed
            
            var textureLogoTeam;
            var lowResolution = false; // Indicates if the player has choosen a low resolution
            var source = 'modelM.json'; // Where to find the models
            
            // Sets up the basics of the scene. Auxiliary function of createMenu()
            function setScene() {
                scene = new THREE.Scene(); // We create the scene
                scene.background = new THREE.Color(0xffffff); // The background is white
            
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000); // We create a perspective camera. (Parameters: fov, aspect ratio, near plane, far plane)
                camera.position.set(-8,5,4); // We move the camera from the origin position
                camera.up = new THREE.Vector3(0,1,0); // The orientation of the camera
                camera.lookAt(new THREE.Vector3(0,0,0)); // We tell the camera to tell at the origin of the scene
            
                renderer = new THREE.WebGLRenderer({antialias: true}); // We create a WebGLRenderer with antialiasing enabled
                renderer.setSize(window.innerWidth, window.innerHeight); // The renderer has the same size of the browser
                renderer.shadowMap.enabled = true; // The renderer is able to render shadows
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Filters shadows through an algorithm
                document.body.appendChild(renderer.domElement); // We add the renderer (which is a canvas) to the body of the HTML file
            
                ambientLight = new THREE.AmbientLight(0xffffff, 1.0); // We create a white ambientLight 
                scene.add(ambientLight);
            
                pointLight = new THREE.PointLight(0xffffff, 1.0); // We create a white pointLight
                pointLight.position.set(9.0, 8.0, 0.0);
                scene.add(pointLight);
            
                pointLight2 = new THREE.PointLight(0xffffff, 1.0); // We create a second white pointLight
                pointLight2.position.set(-2.0, 5.0, 4.0);
                scene.add(pointLight2); 
                
                window.addEventListener('resize', function(event) { // The browser window has changed size!
                    if (lowResolution == false) { // Scale the size of the renderer according to the resolution choosen
                        renderer.setSize(window.innerWidth, window.innerHeight); } 
                    else {
                        renderer.setSize(window.innerWidth/2, window.innerHeight/2);
                        renderer.domElement.style.width = renderer.domElement.width * 2 + 'px';
                        renderer.domElement.style.height = renderer.domElement.height * 2 + 'px'; }
                    camera.aspect = window.innerWidth / window.innerHeight; // Scale the aspect ratio of the camera and update its projection matrix
                    camera.updateProjectionMatrix(); } ); }
            
            // Loads the models in the .json file and add them to the scene. Auxiliary function of createMenu()
            function modelsLoader() {
                loader = new THREE.ObjectLoader(); // Loader we use the load the models
                models = new THREE.Group(); // The 3D models will be saved here
                
                loader.load(source, 
                                    function (object) {
                    models = object; // The models can now be used outside the loader
                    object.traverse(function (child) { // We print on the console the names of the object's children
                        console.log(child.name); } );
                    object.rotateY(-0.3); // We slightly rotate the models for better presentation when the game first loads
                    
                    // Hide elements
                    object.getObjectByName("Torso Cockpit").visible = false; // We hide the children that must NOT show up in the menu
                    object.getObjectByName("Left Hand").visible = false;
                    object.getObjectByName("Right Hand").visible = false;
                    object.getObjectByName("Gameplay Road").visible = false;
                    
                    // Create collisions box
                    collisionBoxPlayerVisible = new THREE.BoxHelper().setFromObject(object.getObjectByName("Front")); // We create an helperBox, which will help us visualize the collision box in the game itself for DEBUGGING purposes
                    collisionBoxPlayerVisible.scale.set(1.0, 0.8, 0.1); // We resize the boxHelper to better fit the front the car
                    collisionBoxPlayerVisible.updateMatrix(); // We update the matrix, so the changes take place
                    collisionBoxPlayerVisible.visible = false;
                    object.getObjectByName("Front").add(collisionBoxPlayerVisible); // Add the helperBox to the scene so we can see it
                    collisionBoxOpponentVisible = new THREE.BoxHelper().setFromObject(object.getObjectByName("Opponent Back")); // We now do the same for the opponent car's back
                    collisionBoxOpponentVisible.scale.set(1.4, 0.8, 0.1);
                    collisionBoxOpponentVisible.updateMatrix();
                    collisionBoxOpponentVisible.name = "Collision Box Visible"; // We add a name, so the box can be referenced later by the getObjectByName() function
                    collisionBoxOpponentVisible.visible = false;
                    object.getObjectByName("Opponent Back").add(collisionBoxOpponentVisible);
                    
                    // Adjust materials
                    object.getObjectByName("Pit Road").material.roughness = 0.80;
                    object.getObjectByName("Gameplay Road").material.roughness = 0.80;
                    
                    // Add textures
                    var texturePirelli = new THREE.TextureLoader().load("textures/Pirelli.png");
                    texturePirelli.wrapS = THREE.RepeatWrapping;
                    texturePirelli.wrapT = THREE.RepeatWrapping;
                    texturePirelli.anisotropy = renderer.getMaxAnisotropy();
                    texturePirelli.rotation = 1.57;
                    object.getObjectByName("Upper Underpass").material.map = texturePirelli;
                    
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Ferrari.png");
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.getMaxAnisotropy();
                    object.getObjectByName("Front Logo").material.map = textureLogoTeam;
                    
                    // Create texture for the screen on the wheel
                    wheelScreenText();
                    
                    scene.add(object);  }, // We add the models to the scene
                
                                    function (xhr) { // We print this if the models are loaded correctly
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded'); },
                
                                    function ( error ) { // We print this if an error has occurred during the loading
                    console.log('An error happened'); } ); }
            
            // Creates the menu screens. Auxiliary function of createMenu()
            function createMenuText() {
                title = document.createElement('div'); // We create the title logo of the game
                title.id = "title"; // How the logo should be rendered is detailed in the style.css file
                title.innerHTML = "Formula Driver"; // The text inside the div
                document.body.appendChild(title);
                
                playButton = document.createElement('button'); // Creates the Play button inside the title element
                playButton.id = "Play";
                playButton.innerHTML = "PLAY";
                playButton.style.background = "yellow"; // The button is yellow as well
                title.appendChild(playButton);
                
                optionsButton = document.createElement('button'); // Creates the Options button inside the title element
                optionsButton.id = "Options";
                optionsButton.innerHTML = "OPTIONS";
                optionsButton.style.background = "yellow";
                title.appendChild(optionsButton);

                aboutButton = document.createElement('button'); // Creates the About button inside the title element
                aboutButton.id = "About";
                aboutButton.innerHTML = "ABOUT";
                aboutButton.style.background = "yellow";
                title.appendChild(aboutButton);
                
                easyButton = document.createElement('button'); // Creates all the buttons inside the Options screen
                easyButton.id = "Easy";
                easyButton.innerHTML = "EASY";
                normalButton = document.createElement('button');
                normalButton.id = "Normal";
                normalButton.innerHTML = "NORMAL";
                normalButton.disabled = true;
                hardButton = document.createElement('button');
                hardButton.id = "Hard";
                hardButton.innerHTML = "HARD";
                resolutionLowButton = document.createElement('button');
                resolutionLowButton.id = "Low";
                resolutionLowButton.innerHTML = "LOW";
                resolutionNativeButton = document.createElement('button');
                resolutionNativeButton.id = "Native";
                resolutionNativeButton.innerHTML = "NATIVE";
                resolutionNativeButton.disabled = true;
                shadowsOffButton = document.createElement('button');
                shadowsOffButton.id = "shadowsOff";
                shadowsOffButton.innerHTML = "OFF";
                shadowsOffButton.disabled = true;
                shadowsOnButton = document.createElement('button');
                shadowsOnButton.id = "shadowsOn";
                shadowsOnButton.innerHTML = "ON";
                ferrariButton = document.createElement('button');
                ferrariButton.id = "Ferrari";
                ferrariButton.innerHTML = "FERRARI";
                ferrariButton.disabled = true;
                mercedesButton = document.createElement('button');
                mercedesButton.id = "Mercedes";
                mercedesButton.innerHTML = "MERCEDES";
                redbullButton = document.createElement('button');
                redbullButton.id = "Redbull";
                redbullButton.innerHTML = "REDBULL";
                
                options = document.createElement('div'); // Creates a div where all the options are displayed
                options.id = "description";
                options.style.textAlign = "center";
                options.innerHTML = "Difficulty: <br>";
                options.appendChild(easyButton); 
                options.appendChild(normalButton);
                options.appendChild(hardButton);
                options.innerHTML += "<br>(Difficulty affects initial speed of the car)";
                options.innerHTML += "<br><br>Resolution: <br>";
                options.appendChild(resolutionLowButton);
                options.appendChild(resolutionNativeButton);
                options.innerHTML += "<br>(If the game runs poorly, choose 'LOW')";
                options.innerHTML += "<br><br>Shadows: <br>";
                options.appendChild(shadowsOffButton);
                options.appendChild(shadowsOnButton);
                options.innerHTML += "<br>('ON' option may impact performance)";
                options.innerHTML += "<br><br>Team: <br>";
                options.appendChild(ferrariButton);
                options.appendChild(mercedesButton);
                options.appendChild(redbullButton);
                options.innerHTML += "<br>(Team selection is purely cosmetic)<br><br>";
                document.body.appendChild(options);
                options.style.visibility = "hidden";
                
                optionsExitButton = document.createElement('button'); // Button that lets you close the Options screen
                optionsExitButton.id = "optionsExit";
                optionsExitButton.innerHTML = "CLOSE";
                options.appendChild(optionsExitButton);
                
                about = document.createElement('div'); // Creates a div where the synopsis and controlls are displayed
                about.id = "description";
                var synopsis = document.createElement('div');
                synopsis.innerHTML = "SYNOPSIS";
                synopsis.style.textAlign = "center";
                about.appendChild(synopsis);
                about.innerHTML += "It was supposed to be an easy weekend, but after an initial crash at the first corner of the race, you find yourself in the last place.<br>";
                about.innerHTML += "Not all hope is lost however.<br>";
                about.innerHTML += "Your car is still the fastest of the grid and the layout of the track, an unnatural long straight, gives you ample possibilities to pass your rivals.<br>";
                about.innerHTML += "See you on the track, driver!<br><br>";
                var controls = document.createElement('div');
                controls.innerHTML = "CONTROLS";
                controls.style.textAlign = "center";
                about.appendChild(controls);
                about.innerHTML += "- 'a': Move your car to the left.<br>";
                about.innerHTML += "- 'd': Move your car to the right.<br>";
                about.innerHTML += "- 'v': Change between the two cameras: third-person or cockpit view.<br>";
                about.innerHTML += "- 'p': Pause or resume the game.<br><br>";
                document.body.appendChild(about);
                about.style.visibility = "hidden";
                
                aboutExitButton = document.createElement('button'); // Button that lets you close the About screen
                aboutExitButton.id = "aboutExit";
                aboutExitButton.innerHTML = "CLOSE";
                var center = document.createElement('div'); // Divider needed to center the button
                center.style.textAlign = "center";
                about.appendChild(center);
                center.appendChild(aboutExitButton); }
            
            // Assign the events to each button in the menu. Auxiliary function of createMenu()
            function assignButtons() {
                // Open Options scren
                optionsButton.onclick = function() {
                    this.disabled = true;
                    aboutButton.disabled = false;
                    options.style.visibility = "visible";
                    about.style.visibility = "hidden"; }
                
                // Option events: difficulty
                document.getElementById("Easy").onclick = function() { // For some reason easyButton.onclick doesn't work: the same for the following buttons
                    this.disabled = true;
                    document.getElementById("Normal").disabled = false;
                    document.getElementById("Hard").disabled = false;
                    difficulty = 0.5; }
                    
                document.getElementById("Normal").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Easy").disabled = false;
                    document.getElementById("Hard").disabled = false;
                    difficulty = 1.0; }
                    
                document.getElementById("Hard").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Easy").disabled = false;
                    document.getElementById("Normal").disabled = false;
                    difficulty = 1.5; }
                 
                // Option events: resolution
                document.getElementById("Low").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Native").disabled = false; 
                    lowResolution = true;
                    renderer.setSize(window.innerWidth/2, window.innerHeight/2); // The renderer is half of its original size
                    renderer.domElement.style.width = renderer.domElement.width * 2 + 'px'; // And then we double the canvas, while the renderer keeps its size
                    renderer.domElement.style.height = renderer.domElement.height * 2 + 'px'; }
                
                document.getElementById("Native").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Low").disabled = false;
                    lowResolution = false;
                    renderer.setSize(window.innerWidth, window.innerHeight); }
                
                // Option events: shadows
                document.getElementById("shadowsOff").onclick = function() {
                    this.disabled = true;
                    document.getElementById("shadowsOn").disabled = false;
                    pointLight.castShadow = false;
                    models.getObjectByName("Body").traverse(function (child) { 
                        child.receiveShadow = false;
                        child.castShadow = false; } );
                    models.getObjectByName("Human").traverse(function (child) { 
                        child.receiveShadoe = false;
                        child.castShadow = false; } );
                    models.getObjectByName("Upper Underpass").castShadow = false;
                    models.getObjectByName("Pit Road").receiveShadow = false;
                    models.getObjectByName("Gameplay Road").receiveShadow = false; }
                    
                document.getElementById("shadowsOn").onclick = function() {
                    this.disabled = true;
                    document.getElementById("shadowsOff").disabled = false; 
                    pointLight.castShadow = true; // The light can cast shadows
                    pointLight.shadow.mapSize.width = 512; // Size of the shadows: the bigger number, the higher quality, but worse performance
                    pointLight.shadow.mapSize.height = 512; 
                    models.getObjectByName("Body").traverse(function (child) { // We enable every object on the scene to receive and cast shadow
                        child.receiveShadow = true;
                        child.castShadow = true; } );
                    models.getObjectByName("Human").traverse(function (child) { 
                        child.receiveShadow = true;
                        child.castShadow = true; } );
                    models.getObjectByName("Upper Underpass").castShadow = true;
                    models.getObjectByName("Front Logo").castShadow = false; // The plane containing the logo can't cast shadow
                    models.getObjectByName("Pit Road").receiveShadow = true;
                    models.getObjectByName("Gameplay Road").receiveShadow = true; }
                
                // Option events: teams
                document.getElementById("Ferrari").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Mercedes").disabled = false;
                    document.getElementById("Redbull").disabled = false;
                    models.getObjectByName("Front").material.color = new THREE.Color(255, 0, 0); // We change the colors on the car
                    models.getObjectByName("Front").material.emissive = new THREE.Color(255, 0, 0); 
                    models.getObjectByName("Body").material.color = new THREE.Color(255, 0, 0);
                    models.getObjectByName("Body").material.emissive = new THREE.Color(255, 0, 0);
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Ferrari.png"); // We load the correct logo
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.getMaxAnisotropy();
                    models.getObjectByName("Front Logo").material.map = textureLogoTeam; }
                    
                document.getElementById("Mercedes").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Ferrari").disabled = false;
                    document.getElementById("Redbull").disabled = false;
                    models.getObjectByName("Front").material.color = new THREE.Color(0, 0, 0);
                    models.getObjectByName("Front").material.emissive = new THREE.Color(0, 128, 128); 
                    models.getObjectByName("Body").material.color = new THREE.Color(0, 0, 0);
                    models.getObjectByName("Body").material.emissive = new THREE.Color(0, 128, 128);
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Mercedes.png"); // We load the correct logo
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.getMaxAnisotropy();
                    models.getObjectByName("Front Logo").material.map = textureLogoTeam;}
                
                document.getElementById("Redbull").onclick = function() {
                    this.disabled = true;
                    document.getElementById("Ferrari").disabled = false;
                    document.getElementById("Mercedes").disabled = false; 
                    models.getObjectByName("Front").material.color = new THREE.Color(0, 0, 160);
                    models.getObjectByName("Front").material.emissive = new THREE.Color(0, 0, 160); 
                    models.getObjectByName("Body").material.color = new THREE.Color(0, 0, 160);
                    models.getObjectByName("Body").material.emissive = new THREE.Color(0, 0, 160);
                    textureLogoTeam = new THREE.TextureLoader().load("textures/Redbull.png");
                    textureLogoTeam.wrapS = THREE.RepeatWrapping;
                    textureLogoTeam.wrapT = THREE.RepeatWrapping;
                    textureLogoTeam.anisotropy = renderer.getMaxAnisotropy();
                    models.getObjectByName("Front Logo").material.map = textureLogoTeam; }
                 
                // Closes Option screen
                optionsExitButton.onclick = function() {
                    optionsButton.disabled = false;
                    options.style.visibility = "hidden"; }
                
                // Open the About screen
                aboutButton.onclick = function() { 
                    this.disabled = true;
                    optionsButton.disabled = false;
                    about.style.visibility = "visible";
                    options.style.visibility = "hidden"; }
                
                // Closes the About screen
                aboutExitButton.onclick = function() {
                    aboutButton.disabled = false;
                    about.style.visibility = "hidden"; }
                
                // Begings the game
                playButton.onclick = function() {
                    createGameplay(); }; }
                    
            // Creates the menu of the game. Auxiliary function of init()
            function createMenu() {
                setScene();
                modelsLoader();
                createMenuText();
                assignButtons(); }
             
            // Animates the menu. Auxiliary function of init()
            function animateMenu() {
                scene.rotateY(0.002); // The entire scene rotate slowly on the Y axis
                menuAnimation = requestAnimationFrame(animateMenu); // The canvas is updated at each frame
                renderer.render(scene, camera); } // We use the renderer to render the scene and the camera
            
            // Spawn a new opponent car for the first time when the game begins. Auxiliary function of createGameplay()
            function createInitialCars() {
                opponents += 1; // ... and update the number of opponent cars!
                if (opponents > maxOpponents) { // Max number of concurrent opponents on screen reached. No more car are created
                    clearInterval(carSpawner); }
                else {
                    createRandomCar(); } }
            
            // Creates the gameplay scene coming from the menu
            function createGameplay() {
                document.title = "Formula Driver - In Game"; // Change the title of the web page
                
                cancelAnimationFrame(menuAnimation); // Stops the spinning animation of the menu
                
                models.getObjectByName("Human").visible = false; // Renders invisible the parts that are not needed in gameplay
                models.getObjectByName("Pit Road").visible = false;
                models.getObjectByName("Gameplay Road").visible = true; // Renders visible the parts that are needed in gameplay
                models.getObjectByName("Torso Cockpit").visible = true;
                models.getObjectByName("Left Hand").visible = true;
                models.getObjectByName("Right Hand").visible = true;
                
                document.body.removeChild(title); // Remove all text on the menu screen
                document.body.removeChild(options);
                document.body.removeChild(about);
                
                scene.rotation.set(0, 0, 0); // Rotates the scene and the models to better fit the gameplay
                models.rotation.set(0, 3.6, 0);
                scene.background = new THREE.Color(0xADD8E6); // Light blue background
                camera.position.set(0.6, 2.1, -0.3); // We set the cockpit cam
                camera.fov = 70; // We change the FOV
                camera.updateProjectionMatrix(); // We update the camera projection matrix so that we can apply the above changes
               
                carSpawner = setInterval(createInitialCars, 800); // We spawn a new initial opponent car every few moments
                
                hud = document.createElement('div');
                hud.id = "hud";
                hud.innerHTML = "Passes: " + passes;
                hud.innerHTML += "<br>Speed: " + difficulty.toFixed(1);
                hud.style.visibility = "hidden";
                document.body.appendChild(hud);
                wheelScreenText();

                document.onkeydown = function() { 
                    if (event.keyCode == 65) { // The player presses 'a': the car needs to turn left
                        leftOrRight = 1; }
                    else if (event.keyCode == 68) { // The player presses 'd': the car needs to turn right
                        leftOrRight = 2; } 
                    else if (event.keyCode == 86 && pause == false) { // The player presses 'v': switches between the two cameras
                        if (cockpit == true) {
                            camera.position.set(-5.6, 5.1, 2.7);
                            document.getElementById("hud").style.visibility = "visible";
                            cockpit = false; }
                        else {
                            camera.position.set(0.6, 2.1, -0.3);
                            document.getElementById("hud").style.visibility = "hidden";
                            cockpit = true; } }
                    else if (event.keyCode == 80 && pause == false) { // The player presses 'p' while playing: the game is paused
                        pause = true;
                        document.title = "Formula Driver - Paused";
                        cancelAnimationFrame(gameplayAnimation); }
                    else if (event.keyCode == 80 && pause == true) { // The player presses 'p' when the pause is on: the game is resumed
                        pause = false;
                        document.title = "Formula Driver - In Game";
                        gameplayAnimation = requestAnimationFrame(animateGameplay); } };
                            
                document.onkeyup = function() { 
                    if (event.keyCode == 65 || event.keyCode == 68) { // The player stops turning
                        leftOrRight = 0; } };
                        
                animateGameplay(); }
            
            // Animates the player's car. Auxiliary function of animateGameplay()
            function animateGameplayPlayer() {
                var rotazione = models.getObjectByName("Left Anterior Tyre").rotation; // Gets the current rotation values of the anterior tyres
                if (leftOrRight == 1 && models.getObjectByName("Gameplay Road").position.z > -7.0) { // The player wants to turn left and there's still place on the road
                    models.getObjectByName("Gameplay Road").translateY(0.2); // Moves the road to right. The player is ALWAYS still.
                    // pointLight.translateY(0.1); // Slightly moves the light as well
                    if (models.getObjectByName("Wheel").rotation.z <= maxSteering) { // Moves the wheel if it hasn't already reached the max steering
                        models.getObjectByName("Wheel").rotateZ(steering); // Turns the wheel to left
                        models.getObjectByName("Body").rotateY(carTurning); // Turns the body of the car to left
                        models.getObjectByName("Head Cockpit").rotateY(headTurning); // Turns the pilot's head to left
                        models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0);  // We apply the x value of the current rotation value (else the animation fails) to the anterior left tyre
                        models.getObjectByName("Left Anterior Tyre").rotateX(-tyreTurning); // Turns the left anterior tyre to the left
                        models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); // The same for the right anterior tyre
                        models.getObjectByName("Right Anterior Tyre").rotateX(-tyreTurning); } }
                else if (leftOrRight == 2 && models.getObjectByName("Gameplay Road").position.z < 7.0) { // The player wants to turn right and there's still place on the road
                        models.getObjectByName("Gameplay Road").translateY(-0.2);
                        // pointLight.translateY(-0.1);
                        if (models.getObjectByName("Wheel").rotation.z >= -maxSteering) {
                            models.getObjectByName("Wheel").rotateZ(-steering);
                            models.getObjectByName("Body").rotateY(-carTurning);
                            models.getObjectByName("Head Cockpit").rotateY(-headTurning);
                            models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                            models.getObjectByName("Left Anterior Tyre").rotateX(tyreTurning);   
                            models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                            models.getObjectByName("Right Anterior Tyre").rotateX(tyreTurning); } }
                else if (leftOrRight == 0) { // The player stopped moving. The car returns to neutral position
                    if (models.getObjectByName("Wheel").rotation.z > 0.1) { // The player was moving to the left
                        models.getObjectByName("Wheel").rotateZ(-steering);
                        models.getObjectByName("Body").rotateY(-carTurning);
                        models.getObjectByName("Head Cockpit").rotateY(-headTurning);
                        models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Left Anterior Tyre").rotateX(tyreTurning);
                        models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Right Anterior Tyre").rotateX(tyreTurning); }
                    else if (models.getObjectByName("Wheel").rotation.z < -0.1) { // The player was moving to the right
                        models.getObjectByName("Wheel").rotateZ(steering);
                        models.getObjectByName("Body").rotateY(carTurning);
                        models.getObjectByName("Head Cockpit").rotateY(headTurning);
                        models.getObjectByName("Left Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Left Anterior Tyre").rotateX(-tyreTurning);
                        models.getObjectByName("Right Anterior Tyre").rotation.set(rotazione.x, 0, 0); 
                        models.getObjectByName("Right Anterior Tyre").rotateX(-tyreTurning); } }
                
                models.getObjectByName("Left Posterior Tyre").rotateZ(tyreSpeed); // Rotates the tyres on the z axis
                models.getObjectByName("Right Posterior Tyre").rotateZ(-tyreSpeed);
                models.getObjectByName("Left Anterior Tyre").rotateZ(tyreSpeed);
                models.getObjectByName("Right Anterior Tyre").rotateZ(-tyreSpeed); }
            
            // Spawns a new opponent car. Auxiliary function of animateGameplayRoad()
            function createRandomCar() {
                var min = -0.385;
                var max = 0.385;
                var positionY = (Math.random() * (max - min) + min).toFixed(3);
                var car = new THREE.Group();
                car = models.getObjectByName("Opponent Body").clone(true);
                car.visible = true;
                models.getObjectByName("Gameplay Road").add(car);
                car.position.set(-spawnPoint, positionY, car.position.z); }
            
            // Animates the obstacles on the road. Auxiliary function of animateGameplay()
            function animateGameplayRoad() {
                models.getObjectByName("Gameplay Road").traverse(function (child) { // Children on the road navigate from negative x to positive x   
                    // Collision check
                    if (child.name == "Opponent Body" && child.position.x > -0.02 && child.position.x < 0.01) {
                        collisionBoxOpponent = new THREE.Box3().setFromObject(child.getObjectByName("Collision Box Visible")); // Creation of collision boxes from boxHelpers
                        collisionBoxPlayer = new THREE.Box3().setFromObject(collisionBoxPlayerVisible);
                        if (collisionBoxOpponent.intersectsBox(collisionBoxPlayer)) { // Check intersection for collisions
                            gameOver(); } }
                    
                    // Pass check
                    if (child.position.x > 0.01 && child.visible == true && child.name == "Opponent Body") { // Check if the opponent is behind you
                        child.visible = false; // Makes the opponent invisible: saves resources
                        passes += 1;
                        if (passes % 50 == 0) { // Check if there are enough passes to increase the speed
                            difficulty += 0.1; }      
                        wheelScreenText(); // Refresh the screen on the wheel
                        document.getElementById("hud").innerHTML = "Passes: " + passes; // Refresh the hud
                        document.getElementById("hud").innerHTML += "<br>Speed: " + difficulty.toFixed(1); }
                    
                    // Spawn check
                    if (child.position.x > spawnPoint/2 && (child.name == "Right Underpass" || child.name == "Left Underpass" || child.name == "Upper Underpass")) {
                        child.position.set(-spawnPoint, child.position.y, child.position.z); } // Spawn a new underpass
                    if (child.position.x > spawnPoint/2 && child.name == "Opponent Body") {
                        createRandomCar(); // Spawn a new car at the begin of the road, and delete the one at the end of it
                        models.getObjectByName("Gameplay Road").remove(child); }
                    
                    // Movement of the objects on the road
                    if (child.name == "Upper Underpass") {
                        child.translateX(speed*difficulty); }
                    else if (child.name == "Left Underpass" || child.name == "Right Underpass") {            
                        child.translateX(-speed*difficulty); }
                    else if (child.name == "Opponent Body") {
                       child.translateX((speed/1.5)*difficulty); } } ); }
            
            // Animates the gameplay scene
            function animateGameplay() {    
                animateGameplayPlayer();
                animateGameplayRoad();
                gameplayAnimation = requestAnimationFrame(animateGameplay);
                renderer.render(scene, camera); }
            
            // The player has hit an opponent's car
            function gameOver() {
                cancelAnimationFrame(gameplayAnimation);
                clearInterval(carSpawner);
                requestAnimationFrame(gameOver); 
                renderer.render(scene, camera); }
            
            // Updates the text on the screen of the wheel. 
            function wheelScreenText() {
                var canvas = document.createElement('canvas'); // Creates a canvas where to write the text on the wheel
                var text = canvas.getContext('2d'); // It returns a CanvasRenderingContext2D: a 2D visualization of what's inside the canvas
                canvas.width = 400; // Size of the canvas
                canvas.height = 150;
                text.font = '50px Helvetica';
                text.fillStyle = 'white'; // Color of the text
                text.fillText('Passes: ' + passes, 70, 55); // Second and third parameter are x, y coordinates of text
                text.fillText('Speed: ' + difficulty.toFixed(1), 70, 120);
                var textureScreen = new THREE.Texture(canvas); // Obtains the canvas as a texture
                textureScreen.wrapS = THREE.RepeatWrapping;
                textureScreen.wrapT = THREE.RepeatWrapping;
                textureScreen.anisotropy = renderer.getMaxAnisotropy();
                textureScreen.needsUpdate = true; // Without this, it doesn't work
                models.getObjectByName("Screen Text").material.map = textureScreen; }
                
            // Creates and animates the menu
            function init() { 
                createMenu();
                animateMenu(); }
            
            // Starts the game
            init();
        </script>
    </body>
</html>